<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>Alan's Page</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="Description" lang="en" content="Alan's Page">
		<meta name="author" content="AlanZheng">
		<meta name="robots" content="index, follow">

		<!-- icons -->
		<link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
		<link rel="shortcut icon" href="/favicon.ico">

		<!-- Override CSS file - add your own CSS rules -->
        <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/styles.css">
        
        <script src="/js/jquery.min.js"></script>
        <script src="/js/steem.min.js"></script>
        <script src="/js/plotly.min.js"></script>
        <script src="/js/page.js"></script>
        
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-8534265-3"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'UA-8534265-3');
        </script>
        
        <!-- google adsense code -->
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-2908538764657933",
            enable_page_level_ads: true
          });
        </script>
        
	</head>
	<body>
    
        <div class="main">
        <script>
        $(document).ready(function(){
            $(".main").load("/mainbar.html");
        });
        </script>
        </div>
    
        <div class="sidebar">
        <script>
        $(document).ready(function(){
            $(".sidebar").load("/sidebar.html");
        });
        </script>
        </div>
        
        <div id="contents">
        
        <p>Input your steemit account name<br>
        how many recent posts do you want to check.<br>
        It will report the "voter" and upvote "count"<br>
        Follow/Upvote me : <a href="https://steemit.com/@alanzheng">https://steemit.com/@alanzheng</a></p>
        <input type="text" id="user" value="alanzheng">
        <input type="number" id="nb" value=1>
        <button type="submit" id="fetch">Who upvote Me</button>
        <div id="counter"></div>
        <script>
	
            steem.api.setOptions( { url: 'https://api.steemit.com' });
            document.getElementById('fetch').addEventListener('click', CalcUpVoted);
            
            function CalcUpVoted()
            {
                // call the main function
                whoUpvotedMe(document.getElementById('user').value);
            }
            
            function whoUpvotedMe(username)
            {
                return steem.api.getDiscussionsByAuthorBeforeDate(
                           username, '', new Date().toISOString().split('.')[0], document.getElementById('nb').value, function (err, posts){
                    const allUpvoters = getAllUpvoters(posts);
                    return countUpvoters(allUpvoters);
                });
            }
            
            function getUpvoters(post)
            {
                return post.active_votes.map(upvote => upvote.voter);
            }
            
            function getAllUpvoters(posts)
            {
                return posts.reduce(
                (all, currentPost) => {
                    const upvoters = getUpvoters(currentPost);
                    return all.concat(upvoters);
                }, []);
            }
            
            function countUpvoters(allUpvoters)
            {
                var ret = allUpvoters.reduce((upvoteCounts, upvoter) => {
                    upvoteCounts[upvoter] = (upvoteCounts[upvoter] || 0) + 1;
                    return upvoteCounts;
                },{});
                
                var node = document.getElementById('counter');
                var xarray = [];
                var yarray = [];
                for (var k in ret)
                {
                    var a = document.createElement('a');
                    a.href =  "https://steemit.com/@" + k;
                    a.innerHTML = k;
                    xarray.push(a);
                    yarray.push(ret[k]);
                }
                
                Plotly.plot( node, [{
                    x: xarray,
                    y: yarray }], { 
                    margin: { t: 0 } } );
                    
                //document.getElementById('counter').innerText += JSON.stringify(ret, null, 2);
                return ret;
            }

        </script>

        </div>
        
	</body>
</html>