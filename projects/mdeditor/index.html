<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>Alan's Page</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="Description" lang="en" content="Alan's Page">
		<meta name="author" content="AlanZheng">
		<meta name="robots" content="index, follow">

		<!-- icons -->
		<link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
		<link rel="shortcut icon" href="/favicon.ico">

		<!-- Override CSS file - add your own CSS rules -->
        <link rel="stylesheet" href="/css/editormd_style.css" />
        <link rel="stylesheet" href="/css/editormd.min.css" />
        <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/styles.css">
        
        <script type= "text/javascript" src="/js/jquery.min.js"></script>
        <script type= "text/javascript" src="/js/editormd.min.js"></script>
        <script type= "text/javascript" src="/js/md5.min.js"></script>
        <script type= "text/javascript" src="/js/steem.min.js"></script>
        <script type= "text/javascript" src="/js/page.js"></script>
        
        <style>
        label { height: 25px; width:10%; }
        input { height: 25px; width: 40%; }
        #author { height: 25px; width: 30%; }
        button { 
            height: 30px; width: 10%;
        }
        </style>
	</head>
	<body>
    
        <div class="main">
        <script>
        $(document).ready(function(){
            $(".main").load("/mainbar.html");
        });
        </script>
        </div>
    
        <div class="sidebar">
        <script>
        $(document).ready(function(){
            $(".sidebar").load("/sidebar.html");
        });
        </script>
        </div>
        
        <div id="contents">
        
        <label>Title: </label><input type="text" id="title" value="">
        <label>tags: </label><input type="text" id="tags" value=""><br>
        <label>Author: </label><input type="text" id="author" value="">
        <label>Wif: </label><input type="text" id="wif" value="">
        <button id="post">Post</button>
        
        <div id="test-editormd">
                <textarea id="textbox"></textarea>
        </div>
        
        <input type="file" id="infile" value="" accept=".md, .txt"><br>
        
        <label>File name: </label><input type="text" id="filename" value="">
        <button id="save">Save to local</button>

        <script>
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('filename').value = today + "-" + "unnamed.md";
            
            var testEditor;
            $(function() {
                testEditor = editormd("test-editormd", {
                    width   : "100%",
                    height  : "500",
                    watch : false,
                    path    : "/js/lib/",
                    toolbarIcons : function() {
                        return ["undo", "redo", "|", "h1", "h2", "h3", "h4", "h5", "h6","|", "bold", "del", "italic", "ucwords", "uppercase", "lowercase", "|",  "hr", "quote", "code", "code-block",  "table",  "list-ul", "list-ol",  "|",  "datetime", "pagebreak", "||", "watch", "fullscreen", "preview"]
                    },
                    
                    toolbarCustomIcons : {
                        file   : "<input type=\"file\" accept=\".md\" />",
                        faicon : "<i class=\"fa fa-star\" onclick=\"alert('faicon');\"></i>"
                    },
                });
            });
            
        // https://jsfiddle.net/k56eezxp/
        (function () {
            var textFile = null,
              makeTextFile = function (text) {
                var data = new Blob([text], {type: 'text/plain'});

                // If we are replacing a previously generated file we need to
                // manually revoke the object URL to avoid memory leaks.
                if (textFile !== null) {
                  window.URL.revokeObjectURL(textFile);
                }

                textFile = window.URL.createObjectURL(data);

                return textFile;
              };


              var save = document.getElementById('save');
              var textbox = document.getElementById('textbox');

              save.addEventListener('click', function ()
              {
                    var link = document.createElement('a');
                    var filename = document.getElementById('filename').value;
                    link.setAttribute('download', filename);
                    link.href = makeTextFile(textbox.value);
                    document.body.appendChild(link);

                    // wait for the link to be added to the document
                    window.requestAnimationFrame(function () {
                    var event = new MouseEvent('click');
                    link.dispatchEvent(event);
                    document.body.removeChild(link);
                    });
                
              }, false);
        })();
        
        $(document).ready(function () 
        {
            var infile = document.getElementById('infile');
              infile.addEventListener('change', function(e)
              {
                  var file = infile.files[0];
                  var reader = new FileReader();
                  reader.onload = function(e) {
                      $('#textbox').val(reader.result);
                  }
                  reader.readAsText(file);
            });
            
			steem.api.setWebSocket("wss://steemd.steemitstage.com");
			$("#post").click(function () 
            {
				/** Broadcast a post */
                var permlink = md5( $("#title").val() );
                var author = $("#author").val();
                var tags = $("#tags").val().split(' ');
                var mainTag = tags[0];
                var title = $("#title").val();
                var postText = $("#textbox").val();
                var authorWif = $("#wif").val();
                steem.broadcast.comment(
                    authorWif,
                    '', // Leave parent author empty
                    mainTag,
                    author,
                    permlink,
                    title,
                    postText,
                    { tags: [ tags[1],tags[2],tags[3],tags[4] ] }, 
                    function(err, result) 
                    {
                        if(!err)
                            alert( JSON.stringify(result, undefined, 2) );
                        else
                            alert( JSON.stringify(err, undefined, 2) );
                    });	
            });
        });
        </script>

        </div>
        
	</body>
</html>