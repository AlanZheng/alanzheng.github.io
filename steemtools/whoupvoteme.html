<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SteemTools: who vote me</title>
    <style type="text/css">
    body {height:100%;text-align:center;}
    a {text-decoration:none;font-weight:bold;color:rgb(26, 80, 153);}
    #fetch {border : solid 2px #ffffff;border-radius : 3px;moz-border-radius : 3px;font-size : 20px;color : #ffffff;	padding : 1px 17px;	background-color : #0a66c9;}
    h1,h2,h3,h4,h5 {color:#0a66c9;}
  </style>
</head>
<body>

<script src="./steem.min.js"></script>
<p>Input your steemit account name<br>
how many recent posts do you want to check.<br>
It will report the "voter" and upvote "count"<br>
Follow/Upvote me : <a href="https://steemit.com/@alanzheng">https://steemit.com/@alanzheng</a></p>
<input type="text" id="user" value="alanzheng">
<input type="number" id="nb" value=1>
<button type="submit" id="fetch">Who upvote Me</button>
<div id="counter"></div>

<script>
	
            steem.api.setOptions( { url: 'https://api.steemit.com' });
            document.getElementById('fetch').addEventListener('click', CalcUpVoted);
            
            function CalcUpVoted()
            {
                // call the main function
                whoUpvotedMe(document.getElementById('user').value);
            }
            
            function whoUpvotedMe(username)
            {
                return steem.api.getDiscussionsByAuthorBeforeDate(
                           username, '', new Date().toISOString().split('.')[0], document.getElementById('nb').value, function (err, posts){
                    const allUpvoters = getAllUpvoters(posts);
                    return countUpvoters(allUpvoters);
                });
            }
            
            function getUpvoters(post)
            {
                return post.active_votes.map(upvote => upvote.voter);
            }
            
            function getAllUpvoters(posts)
            {
                return posts.reduce(
                (all, currentPost) => {
                    const upvoters = getUpvoters(currentPost);
                    return all.concat(upvoters);
                }, []);
            }
            
            function countUpvoters(allUpvoters)
            {
                var ret = allUpvoters.reduce((upvoteCounts, upvoter) => {
                    upvoter = "https://steemit.com/@" + upvoter;
                    upvoteCounts[upvoter] = (upvoteCounts[upvoter] || 0) + 1;
                    return upvoteCounts;
                },{});
                
                var node = document.getElementById('counter');
                while(node.firstChild)
                {
                    node.removeChild(node.firstChild);
                }
                for (var k in ret)
                {
                    var a = document.createElement('a');
                    a.href =  k;
                    a.innerHTML = k;
                    var t = document.createTextNode( "      :       " + ret[k]);
                    var br = document.createElement("br");
                    node.appendChild(a);
                    node.appendChild(t);
                    node.appendChild(br);
                }
                //document.getElementById('counter').innerText += JSON.stringify(ret, null, 2);
                return ret;
            }

</script>

</body>
</html>